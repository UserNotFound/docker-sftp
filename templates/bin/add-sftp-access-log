#!/bin/bash
# add-sftp-access-log [user]
# If no user is specified, all users on the system will be enabled

set -o errexit
set -o nounset


enabled=0

enable () {
  local user="${1}"
  local socketpath="/home/${user}/dev"

  if grep -q "${user}" /etc/rsyslog.d/sftp.conf; then
    echo "User ${user} already found in /etc/rsyslog.d/sftp.conf!!"

  else
    # Add path to chroot for users specific socket
    if [[ ! -d "${socketpath}" ]]; then 
      mkdir -m2755 "${socketpath}"
    fi

    # Add this socket to the syslog configuration file
    socketconfig="$(printf 'input(type="imuxsock" Socket="%s/log" CreatePath="on")', "${socketpath}")"
    echo "${socketconfig}" >> /etc/rsyslog.d/sftp.conf
    echo "${user} enabled"
    (( enabled = enabled + 1 ))
  fi
}

# No user specified, enable for all users found in /home/
if [ $# -lt 1 ]; then

  echo 'All users will have verbose acces logging enabled.'

  for d in /home/*/; do
      user=$(echo "${d}" | awk -F\/ '{print $3}')
      enable "${user}"
  done

else # A user was specified
  
  echo "Enabling verbose logging for ${1}"
  enable "${1}"

fi

# Restart rsyslog only if changes were made
if [ ${enabled} -gt 0 ]; then
  echo "${enabled} user(s) enabled!"
  set +o errexit
  kill -TERM "$(cat /var/run/rsyslogd.pid)"
  sleep 1
  rsyslogd
fi
